# üöÄ Initialization Guide - Feature Setup Order

This guide explains how to properly initialize all features in your `main.dart`.

---

## ‚ö° Quick Start

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';

// Import features
import 'features/theme/theme.dart';
import 'features/connectivity_offline/offline_support.dart';
// Import other features as needed

Future<void> main() async {
  // 1. Ensure Flutter is initialized
  WidgetsFlutterBinding.ensureInitialized();

  // 2. Initialize features in order
  await _initializeFeatures();

  // 3. Run app
  runApp(
    ProviderScope(  // Required for Riverpod (theme management)
      child: MyApp(),
    ),
  );
}

Future<void> _initializeFeatures() async {
  // Initialize in this order
  await _initHive();
  await _initOfflineSupport();
  await _initTheme();
  // await _initFirebase();  // Uncomment if using Firebase
  // await _initSupabase();  // Uncomment if using Supabase
}

Future<void> _initHive() async {
  await Hive.initFlutter();
  // Register adapters if needed
}

Future<void> _initOfflineSupport() async {
  await OfflineSupport.initialize(
    config: OfflineConfig.production(),
  );
}

Future<void> _initTheme() async {
  // Theme controller initializes automatically via Riverpod
  // No manual init needed
}
```

---

## üìã Detailed Initialization Steps

### 1. Hive (Local Database)

**When to use**: If using `connectivity_offline` feature

```dart
import 'package:hive_flutter/hive_flutter.dart';

await Hive.initFlutter();

// Register custom adapters
await OfflineSupport.registerHiveAdapters();
```

**Why first**: Other features may depend on local storage.

---

### 2. Offline Support

**When to use**: For connectivity monitoring and caching

```dart
import 'features/connectivity_offline/offline_support.dart';

await OfflineSupport.initialize(
  config: OfflineConfig(
    debugMode: true,
    maxCacheSizeInMB: 100,
    cacheDuration: Duration(hours: 24),
    enableRequestQueue: true,
  ),
);
```

**Configuration options**:
- `OfflineConfig.development()` - Debug mode
- `OfflineConfig.production()` - Production mode

---

### 3. Theme System

**Always required**: For Material 3 theme support

```dart
// Theme controller auto-initializes via Riverpod
// Just wrap your app with ProviderScope

runApp(
  ProviderScope(
    child: MyApp(),
  ),
);
```

In MaterialApp:

```dart
class MyApp extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final themeMode = ref.watch(themeModeProvider);

    return MaterialApp(
      theme: AppTheme.lightTheme,
      darkTheme: AppTheme.darkTheme,
      themeMode: themeMode,
      home: HomeScreen(),
    );
  }
}
```

---

### 4. Firebase (Optional)

**When to use**: If using Firebase Auth or FCM

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';  // Generated by FlutterFire CLI

await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);
```

**Setup Firebase**:
1. Run: `flutterfire configure`
2. Select your Firebase project
3. This generates `firebase_options.dart`

**For FCM**:

```dart
import 'features/fcm/fcm_notifications.dart';

await FCMService.initialize(
  FCMConfig.production,
);

// Set up notification handlers
FCMService.instance.notificationStream.listen((notification) {
  print('Received: ${notification.title}');
});
```

---

### 5. Supabase (Optional)

**When to use**: If using Supabase authentication

```dart
import 'features/supabase_auth/supabase_auth.dart';

await AuthRepository.initialize(
  SupabaseAuthConfig(
    supabaseUrl: 'YOUR_SUPABASE_URL',
    supabaseAnonKey: 'YOUR_SUPABASE_ANON_KEY',
    enabledProviders: [
      SocialProvider.google,
      SocialProvider.apple,
    ],
    useSecureStorageForSession: true,
    redirectUrl: 'your-app://auth-callback',
  ),
);
```

**Best practice**: Use environment variables:

```dart
await AuthRepository.initialize(
  SupabaseAuthConfig.fromEnvironment(
    env: {
      'SUPABASE_URL': dotenv.env['SUPABASE_URL']!,
      'SUPABASE_ANON_KEY': dotenv.env['SUPABASE_ANON_KEY']!,
    },
    enabledProviders: [SocialProvider.google, SocialProvider.apple],
  ),
);
```

---

## üéØ Complete Example

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:hive_flutter/hive_flutter.dart';
import 'package:firebase_core/firebase_core.dart';

// Features
import 'features/theme/theme.dart';
import 'features/connectivity_offline/offline_support.dart';
import 'features/fcm/fcm_notifications.dart';
import 'features/supabase_auth/supabase_auth.dart';

// Config
import 'firebase_options.dart';
import 'core/config/app_config.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  try {
    // Initialize features in order
    await _initializeApp();

    runApp(
      ProviderScope(
        child: MyApp(),
      ),
    );
  } catch (e, stackTrace) {
    print('Initialization error: $e');
    print(stackTrace);

    // Show error screen
    runApp(
      MaterialApp(
        home: Scaffold(
          body: Center(
            child: Text('Failed to start app. Please restart.'),
          ),
        ),
      ),
    );
  }
}

Future<void> _initializeApp() async {
  // 1. Hive (for offline storage)
  await Hive.initFlutter();
  await OfflineSupport.registerHiveAdapters();

  // 2. Offline support
  await OfflineSupport.initialize(
    config: OfflineConfig.production(),
  );

  // 3. Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // 4. FCM
  await FCMService.initialize(FCMConfig.production);

  // 5. Supabase
  await AuthRepository.initialize(
    SupabaseAuthConfig(
      supabaseUrl: AppConfig.supabaseUrl,
      supabaseAnonKey: AppConfig.supabaseAnonKey,
      enabledProviders: [SocialProvider.google, SocialProvider.apple],
      useSecureStorageForSession: true,
    ),
  );

  // Theme initializes automatically
}

class MyApp extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final themeMode = ref.watch(themeModeProvider);

    return MaterialApp(
      title: 'My App',
      theme: AppTheme.lightTheme,
      darkTheme: AppTheme.darkTheme,
      themeMode: themeMode,
      home: HomeScreen(),
    );
  }
}

class HomeScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Home'),
      ),
      body: Center(
        child: Text('App Initialized Successfully!'),
      ),
    );
  }
}
```

---

## ‚ö†Ô∏è Common Issues

### Issue 1: Hive boxes not opening

**Solution**: Ensure Hive is initialized before opening boxes:

```dart
await Hive.initFlutter();
// Now safe to open boxes
await Hive.openBox('myBox');
```

### Issue 2: Theme not persisting

**Solution**: Ensure ProviderScope wraps MaterialApp:

```dart
runApp(
  ProviderScope(  // Must wrap MaterialApp
    child: MyApp(),
  ),
);
```

### Issue 3: Firebase not initialized

**Solution**: Await Firebase.initializeApp():

```dart
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);
```

### Issue 4: Supabase redirect not working

**Solution**: Configure deep links in AndroidManifest.xml and Info.plist

---

## üìù Checklist

Before running your app:

- [ ] WidgetsFlutterBinding.ensureInitialized() called
- [ ] Hive initialized (if using offline support)
- [ ] Offline support initialized (if needed)
- [ ] Firebase initialized (if using Firebase)
- [ ] Supabase initialized (if using Supabase)
- [ ] App wrapped with ProviderScope
- [ ] Theme providers set up in MaterialApp

---

## üîÑ Initialization Flow Diagram

```
main()
  ‚Üì
WidgetsFlutterBinding.ensureInitialized()
  ‚Üì
Hive.initFlutter()
  ‚Üì
OfflineSupport.registerHiveAdapters()
  ‚Üì
OfflineSupport.initialize()
  ‚Üì
Firebase.initializeApp() [Optional]
  ‚Üì
FCMService.initialize() [Optional]
  ‚Üì
AuthRepository.initialize() [Optional]
  ‚Üì
runApp(ProviderScope(child: MyApp()))
  ‚Üì
MaterialApp with theme
  ‚Üì
HomeScreen
```

---

## üìö Related Documentation

- [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - Feature structure
- [lib/features/theme/THEME_README.md](lib/features/theme/THEME_README.md) - Theme system docs
- [lib/features/connectivity_offline/README.md](lib/features/connectivity_offline/README.md) - Offline support
- [lib/features/fcm/README.md](lib/features/fcm/README.md) - FCM setup
- [lib/features/supabase_auth/README.md](lib/features/supabase_auth/README.md) - Supabase auth

---

**Last Updated**: 2025-11-14
