# Firebase Authentication Module

Production-ready, complete Firebase Authentication implementation for Flutter apps.

## Features

- **Email/Password Authentication** - Sign up, sign in, password reset
- **Phone OTP Authentication** - SMS verification with auto-retrieval
- **Social Sign-In** - Google, Apple (iOS), Facebook
- **Anonymous Sign-In** - Guest access with upgrade option
- **Account Linking** - Link multiple auth providers to one account
- **Email Verification** - Send and verify email addresses
- **Password Management** - Change password, forgot password flows
- **Token Management** - Secure storage with refresh logic
- **Reauthentication** - For sensitive operations (password change, account deletion)
- **Profile Management** - Update display name, photo URL
- **Complete UI** - Pre-built screens for all flows
- **Dependency Injection** - Riverpod and GetIt examples
- **Error Handling** - User-friendly error messages
- **Null-safe** - Full null-safety support
- **Well-documented** - Comprehensive dartdoc on all APIs

## Table of Contents

- [Quick Start](#quick-start)
- [Firebase Project Setup](#firebase-project-setup)
- [Platform Setup](#platform-setup)
- [Dependencies](#dependencies)
- [Integration](#integration)
- [Usage Examples](#usage-examples)
- [UI Components](#ui-components)
- [Error Handling](#error-handling)
- [Server-Side Verification](#server-side-verification)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)

## Quick Start

### 1. Import the module

```dart
import 'package:reuablewidgets/features/firebase_auth/firebase_auth.dart';
```

### 2. Initialize Firebase in main.dart

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by FlutterFire CLI

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  runApp(MyApp());
}
```

### 3. Set up dependency injection

**Option A: Riverpod** (Recommended)

```dart
import 'package:flutter_riverpod/flutter_riverpod.dart';

void main() async {
  // ... Firebase initialization

  runApp(
    ProviderScope(
      child: MyApp(),
    ),
  );
}

class MyApp extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final authState = ref.watch(authStateProvider);

    return MaterialApp(
      home: authState.when(
        data: (user) => user != null ? HomeScreen() : SignInScreen(),
        loading: () => CircularProgressIndicator(),
        error: (error, stack) => ErrorScreen(error: error),
      ),
    );
  }
}
```

**Option B: GetIt**

```dart
import 'package:get_it/get_it.dart';

void main() async {
  // ... Firebase initialization

  registerAuthDependencies(); // Register all auth services

  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final authService = GetIt.I<AuthService>();

    return MaterialApp(
      home: StreamBuilder<UserModel?>(
        stream: authService.authStateChanges,
        builder: (context, snapshot) {
          if (snapshot.connectionState == ConnectionState.waiting) {
            return CircularProgressIndicator();
          }
          return snapshot.hasData ? HomeScreen() : SignInScreen();
        },
      ),
    );
  }
}
```

### 4. Use authentication

```dart
class SignInButton extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return ElevatedButton(
      onPressed: () async {
        final authService = ref.read(authServiceProvider);

        try {
          await authService.signInWithGoogle();
        } on AuthError catch (e) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(e.message)),
          );
        }
      },
      child: Text('Sign in with Google'),
    );
  }
}
```

## Firebase Project Setup

### 1. Create Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Click "Add project"
3. Enter project name
4. (Optional) Enable Google Analytics
5. Click "Create project"

### 2. Enable Authentication Providers

In Firebase Console → Authentication → Sign-in method:

#### Email/Password
- Click "Email/Password"
- Toggle "Enable"
- Click "Save"

#### Google Sign-In
- Click "Google"
- Toggle "Enable"
- Enter support email
- Click "Save"

#### Phone Authentication
- Click "Phone"
- Toggle "Enable"
- Add test phone numbers (optional, for testing)
- Click "Save"
- **Note**: Requires billing enabled (Firebase Blaze plan)

#### Apple Sign-In (iOS only)
- Click "Apple"
- Toggle "Enable"
- Configure Services ID from Apple Developer account
- Upload private key (.p8 file)
- Enter Team ID and Key ID
- Click "Save"

#### Facebook Login
- Click "Facebook"
- Toggle "Enable"
- Enter App ID and App Secret from Facebook Developer Console
- Click "Save"

### 3. Configure FlutterFire CLI

```bash
# Install FlutterFire CLI
dart pub global activate flutterfire_cli

# Configure Firebase for your Flutter project
flutterfire configure
```

This generates `lib/firebase_options.dart` with your Firebase configuration.

## Platform Setup

### Android Setup

#### 1. Add google-services.json

1. In Firebase Console → Project Settings → Your apps
2. Select your Android app (or add one with your package name)
3. Download `google-services.json`
4. Place in `android/app/`

#### 2. Update build.gradle

`android/build.gradle`:
```gradle
buildscript {
    dependencies {
        classpath 'com.google.gms:google-services:4.3.15'
    }
}
```

`android/app/build.gradle`:
```gradle
apply plugin: 'com.google.gms.google-services'

android {
    defaultConfig {
        minSdkVersion 21  // Firebase Auth requires min SDK 21
    }
}
```

#### 3. Get SHA-1 Fingerprint (for Google Sign-In)

```bash
cd android
./gradlew signingReport
```

Copy the SHA-1 fingerprint from output and add it to Firebase Console → Project Settings → Your apps → SHA certificate fingerprints.

#### 4. Google Sign-In Configuration

No additional Android-specific configuration needed. The SHA-1 fingerprint is sufficient.

### iOS Setup

#### 1. Add GoogleService-Info.plist

1. In Firebase Console → Project Settings → Your apps
2. Select your iOS app (or add one with your bundle ID)
3. Download `GoogleService-Info.plist`
4. Open Xcode, drag file into `Runner` folder
5. Ensure "Copy items if needed" is checked

#### 2. Update Info.plist

Add URL schemes for Google Sign-In:

```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleTypeRole</key>
        <string>Editor</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <!-- Replace with your REVERSED_CLIENT_ID from GoogleService-Info.plist -->
            <string>com.googleusercontent.apps.YOUR_REVERSED_CLIENT_ID</string>
        </array>
    </dict>
</array>
```

#### 3. Apple Sign-In Configuration

Add capability in Xcode:
1. Open project in Xcode
2. Select target → Signing & Capabilities
3. Click "+ Capability"
4. Add "Sign in with Apple"

#### 4. Minimum iOS Version

Ensure `ios/Podfile` has iOS 12.0 or higher:

```ruby
platform :ios, '12.0'
```

### Web Setup

#### 1. Add Firebase Config

The `flutterfire configure` command handles this automatically.

#### 2. Add Authorized Domains

In Firebase Console → Authentication → Settings → Authorized domains:
- Add your production domain
- `localhost` is already authorized for development

#### 3. Google Sign-In on Web

No additional configuration needed.

### Facebook Setup

#### 1. Create Facebook App

1. Go to [Facebook Developers](https://developers.facebook.com/)
2. Create a new app
3. Add "Facebook Login" product
4. Configure OAuth redirect URIs

#### 2. Get App ID and Secret

From Facebook App Dashboard:
- Copy App ID
- Copy App Secret
- Add both to Firebase Console → Authentication → Facebook

#### 3. Platform-Specific Configuration

**Android** (`android/app/src/main/res/values/strings.xml`):
```xml
<string name="facebook_app_id">YOUR_FACEBOOK_APP_ID</string>
<string name="fb_login_protocol_scheme">fbYOUR_FACEBOOK_APP_ID</string>
```

**iOS** (`ios/Runner/Info.plist`):
```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleURLSchemes</key>
    <array>
      <string>fbYOUR_FACEBOOK_APP_ID</string>
    </array>
  </dict>
</array>
<key>FacebookAppID</key>
<string>YOUR_FACEBOOK_APP_ID</string>
<key>FacebookDisplayName</key>
<string>YOUR_APP_NAME</string>
```

## Dependencies

Add to `pubspec.yaml`:

```yaml
dependencies:
  flutter:
    sdk: flutter

  # Firebase
  firebase_core: ^2.24.0
  firebase_auth: ^4.16.0

  # Social Sign-In
  google_sign_in: ^6.1.5
  sign_in_with_apple: ^5.0.0
  flutter_facebook_auth: ^6.0.3

  # Secure Storage
  flutter_secure_storage: ^9.0.0
  shared_preferences: ^2.2.0

  # State Management (choose one)
  flutter_riverpod: ^2.4.0  # Recommended
  # get_it: ^7.6.0           # Alternative

dev_dependencies:
  flutter_test:
    sdk: flutter
  mockito: ^5.4.0
  build_runner: ^2.4.0
```

Run:
```bash
flutter pub get
```

## Integration

### Module Structure

The module is organized as follows:

```
lib/features/firebase_auth/
├── firebase_auth.dart          # Public API exports
├── models/
│   └── user_model.dart         # User domain model
├── services/
│   └── auth_service.dart       # Main authentication service
├── repository/
│   └── auth_repository.dart    # Firebase SDK wrapper
├── storage/
│   └── token_store.dart        # Secure token storage
├── errors/
│   └── auth_error.dart         # Error handling
├── utils/
│   └── validators.dart         # Input validators
├── providers/
│   └── auth_providers.dart     # DI providers (Riverpod/GetIt)
└── ui/
    ├── sign_in_screen.dart     # Sign-in UI
    ├── sign_up_screen.dart     # Sign-up UI
    ├── phone_signin_screen.dart # Phone OTP UI
    └── profile_screen.dart     # Profile management UI
```

### Architecture

```
UI Layer (Screens/Widgets)
        ↓
Service Layer (AuthService)
        ↓
Repository Layer (AuthRepository)
        ↓
Storage Layer (TokenStore)
        ↓
Firebase SDK
```

## Usage Examples

### Email/Password Authentication

#### Sign Up

```dart
try {
  final user = await authService.signUpWithEmail(
    email: 'user@example.com',
    password: 'password123',
    displayName: 'John Doe', // Optional
  );

  print('User created: ${user.email}');
} on AuthError catch (e) {
  if (e.code == 'email-in-use') {
    print('Email already registered');
  } else {
    print('Error: ${e.message}');
  }
}
```

#### Sign In

```dart
try {
  final user = await authService.signInWithEmail(
    email: 'user@example.com',
    password: 'password123',
  );

  print('Signed in: ${user.email}');
} on AuthError catch (e) {
  if (e.code == 'wrong-password') {
    print('Incorrect password');
  } else if (e.code == 'user-not-found') {
    print('No account found with this email');
  } else {
    print('Error: ${e.message}');
  }
}
```

#### Password Reset

```dart
try {
  await authService.sendPasswordReset('user@example.com');
  print('Password reset email sent');
} on AuthError catch (e) {
  print('Error: ${e.message}');
}
```

### Social Sign-In

#### Google Sign-In

```dart
try {
  final user = await authService.signInWithGoogle();
  print('Signed in with Google: ${user.email}');
} on AuthError catch (e) {
  if (e.code == AuthErrorCodes.cancelled) {
    print('User cancelled sign-in');
  } else {
    print('Error: ${e.message}');
  }
}
```

#### Apple Sign-In (iOS only)

```dart
try {
  final user = await authService.signInWithApple();
  print('Signed in with Apple: ${user.email ?? user.uid}');
} on AuthError catch (e) {
  if (e.code == AuthErrorCodes.cancelled) {
    print('User cancelled sign-in');
  } else {
    print('Error: ${e.message}');
  }
}
```

### Phone Authentication

```dart
// Step 1: Send OTP
await authService.verifyPhoneNumber(
  phoneNumber: '+15551234567', // E.164 format
  codeSent: (verificationId, resendToken) {
    print('OTP sent, show input screen');
    _showOtpInputDialog(verificationId);
  },
  verificationCompleted: (credential) {
    // Auto-verification (Android only)
    print('Phone auto-verified');
  },
  verificationFailed: (error) {
    print('Verification failed: ${error.message}');
  },
);

// Step 2: Verify OTP
try {
  final user = await authService.verifyPhoneOtp(
    verificationId: verificationId,
    smsCode: '123456',
  );
  print('Phone verified: ${user.phoneNumber}');
} on AuthError catch (e) {
  if (e.code == AuthErrorCodes.invalidCode) {
    print('Invalid OTP code');
  } else {
    print('Error: ${e.message}');
  }
}
```

### Account Linking

```dart
// Link Google to current user
try {
  final updatedUser = await authService.linkWithGoogle();
  print('Google account linked');
} on AuthError catch (e) {
  if (e.code == 'credential-already-in-use') {
    print('This Google account is already linked to another user');
  } else if (e.code == 'provider-already-linked') {
    print('Google is already linked to this account');
  } else {
    print('Error: ${e.message}');
  }
}

// Unlink provider
try {
  await authService.unlinkProvider('google.com');
  print('Google account unlinked');
} on AuthError catch (e) {
  print('Error: ${e.message}');
}
```

### Email Verification

```dart
// Send verification email
try {
  await authService.sendEmailVerification();
  print('Verification email sent');
} on AuthError catch (e) {
  print('Error: ${e.message}');
}

// Check if email is verified
final isVerified = authService.isEmailVerified;
if (!isVerified) {
  print('Please verify your email');
}

// Check verification status after user clicks link
final nowVerified = await authService.checkEmailVerified();
if (nowVerified) {
  print('Email verified!');
}
```

### Profile Management

```dart
// Update display name and photo
try {
  await authService.updateProfile(
    displayName: 'John Smith',
    photoUrl: 'https://example.com/photo.jpg',
  );
  print('Profile updated');
} on AuthError catch (e) {
  print('Error: ${e.message}');
}
```

### Token Management

```dart
// Get ID token for backend authentication
final token = await authService.getIdToken();
print('ID Token: $token');

// Force token refresh
final newToken = await authService.refreshToken();

// Use token in API requests
final response = await http.get(
  Uri.parse('https://yourapi.com/protected'),
  headers: {
    'Authorization': 'Bearer $token',
  },
);
```

### Reauthentication

Required before sensitive operations like password change or account deletion:

```dart
try {
  // Reauthenticate first
  await authService.reauthenticateWithEmail(
    email: user.email!,
    password: currentPassword,
  );

  // Now perform sensitive operation
  await authService.changePassword(newPassword);
  print('Password changed successfully');
} on AuthError catch (e) {
  if (e.code == AuthErrorCodes.wrongPassword) {
    print('Current password is incorrect');
  } else {
    print('Error: ${e.message}');
  }
}
```

### Account Deletion

```dart
try {
  await authService.deleteAccount();
  print('Account deleted');
} on AuthError catch (e) {
  if (e.code == AuthErrorCodes.requiresReauth) {
    print('Please sign in again before deleting your account');
  } else {
    print('Error: ${e.message}');
  }
}
```

### Sign Out

```dart
try {
  await authService.signOut();
  print('Signed out');
} on AuthError catch (e) {
  print('Error: ${e.message}');
}
```

## UI Components

### SignInScreen

Pre-built sign-in screen with email/password and social sign-in:

```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (_) => SignInScreen(
      onSignInSuccess: () {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (_) => HomeScreen()),
        );
      },
      showSocialSignIn: true,
      showSignUpLink: true,
    ),
  ),
);
```

### SignUpScreen

Account creation screen:

```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (_) => SignUpScreen(
      onSignUpSuccess: () {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (_) => HomeScreen()),
        );
      },
      sendEmailVerification: true,
    ),
  ),
);
```

### PhoneSignInScreen

Phone OTP authentication:

```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (_) => PhoneSignInScreen(
      onSignInSuccess: () {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (_) => HomeScreen()),
        );
      },
      defaultCountryCode: '1', // US
    ),
  ),
);
```

### ProfileScreen

Profile management and linked accounts:

```dart
Navigator.push(
  context,
  MaterialPageRoute(builder: (_) => ProfileScreen()),
);
```

## Error Handling

All authentication methods throw `AuthError` exceptions with:
- `code` - Error code (e.g., 'email-in-use', 'wrong-password')
- `message` - User-friendly error message
- `isRecoverable` - Whether the error can be recovered from
- `firebaseCode` - Original Firebase error code

```dart
try {
  await authService.signInWithEmail(email: email, password: password);
} on AuthError catch (e) {
  switch (e.code) {
    case AuthErrorCodes.userNotFound:
      print('No account found with this email');
      break;
    case AuthErrorCodes.wrongPassword:
      print('Incorrect password');
      break;
    case AuthErrorCodes.tooManyRequests:
      print('Too many failed attempts. Try again later.');
      break;
    default:
      print('Error: ${e.message}');
  }
}
```

### Common Error Codes

- `email-in-use` - Email already registered
- `wrong-password` - Incorrect password
- `user-not-found` - No account with this email
- `invalid-email` - Malformed email address
- `weak-password` - Password too weak
- `requires-reauth` - Need to reauthenticate
- `credential-already-in-use` - Credential linked to another account
- `provider-already-linked` - Provider already linked
- `invalid-code` - Invalid OTP code
- `cancelled` - User cancelled operation
- `network-error` - Network connection failed

## Server-Side Verification

### Get ID Token

```dart
final token = await authService.getIdToken();

// Send to backend
final response = await http.post(
  Uri.parse('https://yourapi.com/protected'),
  headers: {'Authorization': 'Bearer $token'},
  body: jsonEncode({'data': 'your data'}),
);
```

### Backend Verification (Node.js)

```javascript
const admin = require('firebase-admin');

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

async function verifyToken(req, res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).send('Unauthorized');
  }

  const token = authHeader.split('Bearer ')[1];

  try {
    const decodedToken = await admin.auth().verifyIdToken(token);
    req.userId = decodedToken.uid;
    req.userEmail = decodedToken.email;
    next();
  } catch (error) {
    console.error('Token verification failed:', error);
    res.status(401).send('Unauthorized');
  }
}

// Use as middleware
app.post('/api/protected', verifyToken, (req, res) => {
  res.json({ message: `Hello ${req.userEmail}!` });
});
```

### Backend Verification (Python/Flask)

```python
import firebase_admin
from firebase_admin import auth, credentials
from flask import Flask, request, jsonify

cred = credentials.Certificate('path/to/serviceAccountKey.json')
firebase_admin.initialize_app(cred)

app = Flask(__name__)

def verify_token(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization', '').replace('Bearer ', '')

        if not token:
            return jsonify({'error': 'Unauthorized'}), 401

        try:
            decoded_token = auth.verify_id_token(token)
            request.user_id = decoded_token['uid']
            request.user_email = decoded_token.get('email')
            return f(*args, **kwargs)
        except Exception as e:
            print(f'Token verification failed: {e}')
            return jsonify({'error': 'Unauthorized'}), 401

    return decorated_function

@app.route('/api/protected', methods=['POST'])
@verify_token
def protected_route():
    return jsonify({'message': f'Hello {request.user_email}!'})
```

## Testing

### Unit Tests

See `lib/features/firebase_auth/test/auth_service_test.dart` for examples.

Run tests:
```bash
flutter test lib/features/firebase_auth/test/
```

### Manual Testing Checklist

**Email/Password**:
- [ ] Sign up with new email
- [ ] Sign up with existing email (should fail)
- [ ] Sign in with correct credentials
- [ ] Sign in with wrong password (should fail)
- [ ] Send password reset email
- [ ] Change password after reauthentication

**Phone**:
- [ ] Send OTP to valid phone number
- [ ] Verify with correct OTP
- [ ] Verify with incorrect OTP (should fail)
- [ ] Resend OTP

**Social Sign-In**:
- [ ] Google Sign-In
- [ ] Apple Sign-In (iOS only)
- [ ] Facebook Login
- [ ] Cancel social sign-in (should handle gracefully)

**Account Linking**:
- [ ] Link Google to email account
- [ ] Link email to social account
- [ ] Unlink provider
- [ ] Try linking already-linked credential (should fail)

**Email Verification**:
- [ ] Send verification email
- [ ] Check verification status

**Profile**:
- [ ] Update display name
- [ ] Update photo URL

**Account Deletion**:
- [ ] Delete account after reauthentication
- [ ] Try deleting without reauth (should fail)

## Troubleshooting

### Firebase not initializing
**Error**: `[core/no-app] No Firebase App '[DEFAULT]' has been created`

**Solution**: Ensure you call `Firebase.initializeApp()` before using any Firebase services:
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  runApp(MyApp());
}
```

### Google Sign-In not working on Android
**Error**: `DEVELOPER_ERROR` or `10`

**Solution**:
1. Get your SHA-1 fingerprint: `cd android && ./gradlew signingReport`
2. Add it to Firebase Console → Project Settings → SHA certificate fingerprints
3. Download updated `google-services.json` and replace in `android/app/`
4. Clean and rebuild: `flutter clean && flutter pub get && flutter run`

### Phone authentication not working
**Error**: `MISSING_CLIENT_IDENTIFIER` or quota exceeded

**Solution**:
1. Enable billing in Firebase (Phone auth requires Blaze plan)
2. For iOS: Ensure reCAPTCHA verification is configured
3. Check quota limits in Firebase Console → Authentication → Usage

### Apple Sign-In not working
**Error**: `Missing Service ID` or `Invalid configuration`

**Solution**:
1. Add "Sign in with Apple" capability in Xcode
2. Configure Service ID in Apple Developer account
3. Upload private key (.p8) to Firebase Console
4. Add correct Team ID and Key ID

### Facebook Login not working
**Error**: `Invalid key hash`

**Solution**:
1. Generate key hash:
   ```bash
   keytool -exportcert -alias androiddebugkey -keystore ~/.android/debug.keystore | openssl sha1 -binary | openssl base64
   ```
2. Add key hash to Facebook App → Settings → Basic → Key Hashes

### Token storage issues
**Error**: Tokens not persisting or `PlatformException`

**Solution**:
- For Android: Ensure `minSdkVersion` is 21+
- For iOS: Check Keychain access permissions
- Use `HybridTokenStore` for best compatibility:
  ```dart
  final tokenStore = HybridTokenStore(); // Uses secure storage + SharedPreferences
  ```

### Build errors after adding dependencies
**Error**: Version conflicts or gradle errors

**Solution**:
```bash
flutter clean
flutter pub get
cd android && ./gradlew clean
cd ..
flutter run
```

For iOS:
```bash
cd ios
rm Podfile.lock
pod repo update
pod install
cd ..
flutter run
```

## License

This module is part of the reusable_widgets project.

## Support

For issues and questions:
1. Check this README
2. Check Firebase documentation: https://firebase.google.com/docs/auth
3. Check FlutterFire documentation: https://firebase.flutter.dev/
4. File an issue in the repository

## Contributing

Contributions are welcome! Please ensure:
- Code follows existing patterns
- All tests pass
- Documentation is updated
- Commits are clear and descriptive
